<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0,minimal-ui">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <title>模切之家</title>
    <meta http-equiv="x-ua-compatible" content="IE=edge" />
    <meta name="renderer" content="webkit" />
    <script src="//cdn.bootcss.com/angular.js/1.4.9/angular.js"></script>
    <style>
      html{font-size: 100%}
    </style>

</head>
<body ng-app="myApp" >
    <div ajax-upload id="file" name="pics" action="angular-file-upload/examples/simple/upload.php"></div>
    <div class="" ng-bind="info"></div>
</body>
<script type="text/javascript">
"user strcit";
var app = angular.module("myApp",[]);
app.directive("ajaxUpload",function($http){
    return {
        restrict : "EA",
        template : "",
        replace : false,
        scope : {},
        controller:function($scope,$element,$attrs){
            console.log($scope.info)
        },
        link:function($scope,$element,$attrs){
            var def = {
                action : $attrs.action || "",
                method : $attrs.method || "post",
                enctype : "multipart/form-data",
                accept : $attrs.accept || "*/*",
                name : $attrs.name || "file",
                auto : $attrs.auto || true
            }

            var iframeName = "WMupload"+Date.now();
            //表单
            var frm = document.createElement('form');
                frm.target=iframeName;
                frm.action= def.action;
                frm.method="post";
                frm.enctype=def.enctype;
            //框架
            var ifr = document.createElement('iframe');
                ifr.name=iframeName;
                ifr.id=iframeName;
                ifr.style.display = 'none';
            //Input file
            var fin = document.createElement('input');
                fin.type="file";
                fin.name=def.name;
                frm.appendChild(fin);
            //创建预览区
            var pre = document.createElement("div");

            //生成上传所需元素
            $element[0].appendChild(frm);
            $element[0].appendChild(ifr);
            $element[0].appendChild(pre);
            //console.log(document.getElementById(iframeName));
            //自动提交上传动作
            fin.addEventListener("change", function(){
                var reader = new FileReader();
                    reader.readAsDataURL(this.files[0]);
                    reader.onload = function(){
                        pre.innerHTML = '<img src="'+reader.result+'" style="height:200px" />';
                    }
                //frm.submit();
            },false)
            ifr.addEventListener("load",function(){
                var status = 200;
                var html = '';
                try {
                    // fixed angular.contents() for iframes
                    html = ifr.contentDocument.body.innerHTML;
                } catch (e) {
                    // in case we run into the access-is-denied error or we have another error on the server side
                    // (intentional 500,40... errors), we at least say 'something went wrong' -> 500
                    status = 500;
                }
                try {
                    var rsJson = JSON.parse(html);
                    // statements
                } catch(e) {
                    // statements
                    status = 900;
                }
                $scope.info =rsJson || {status:90};
            })
        }
 
    }  
})
  


 /* var file = this.files[0];
        var res =  new FileReader();
            res.readAsDataURL(file);
            res.onload = function(){
                data=res.result.split(',')[1];
                data=window.atob(data);
                
                var ia = new Uint8Array(data.length);
                for (var i = 0; i < data.length; i++) {
                    ia[i] = data.charCodeAt(i);
                };

                // canvas.toDataURL 返回的默认格式就是 image/png
                var blob=new Blob([ia], {type:"image/png"});

                console.log(blob)
                var fd = new FormData();
                    fd.append('file',blob);
                $http({
                    method:"post",
                    url:"http://127.0.0.1/angular-file-upload/examples/simple/upload.php",
                    headers:{"Content-Type":"multipart/form-data","Accept":"*"},
                    data:fd,
                    success:function(data){

                    }
                })

            }*/
    // 以下四个参数由第三步获得
   /* var img = document.getElementById("tupian");
var x=0,  
    y=0,
    width=200,      //裁切宽度
    height=150,     //裁切高度
    w =  parseInt(img.style.width),        //裁切图像是最大宽度（即原图片的宽度）
    h = parseInt(img.style.height);         //同上
var canvas= document.createElement("canvas");
    canvas.width= width;
    canvas.height = height;
    canvas.style.background = "#eee"
    document.body.appendChild(canvas);
    ctx= document.getElementById("canvas").getContext('2d');
    ctx.drawImage(img,50,50,w,h,0,0,width,height);*/

    /*window.onmousewheel = function(e){
        if(e.wheelDelta>0){
            if(w>img.width)
            ctx.drawImage(img,50,50,w,h,0,0,width,height);
        }else{

        }
    }*/
    var imgScale = {
            // 判断设备是否支持touch事件
            touch: ('ontouchstart' in window) || window.DocumentTouch && document instanceof DocumentTouch,
            imgScale: document.getElementById('imgScale'),
            // 事件
            events: {            
                index: 0,     
                aVal:"",
                cVal:"",          
                ow : "",
                oh : "",
                imgScale: this.imgScale,    
                cgObj:document.getElementById('img'),   
                handleEvent: function(event) {
                    // this指events对象
                    var self = this;
                    this.oh = parseInt(this.cgObj.style.height);
                    if (event.type == 'touchstart') {
                        self.start(event);
                    } else if(event.type == 'touchmove') {
                        self.move(event);
                    } else if(event.type == 'touchend') {
                        self.end(event);
                    }
                },
 
                // 滑动开始
                start: function(event) {
                    event.preventDefault();                      // 阻止触摸事件的默认动作,即阻止滚屏
                    this.imgScale.addEventListener('touchmove', this, false);
                    this.imgScale.addEventListener('touchend', this, false);
                    this.aVal = event.targetTouches[0].pageY ;
                    this.cVal = event.targetTouches[1].pageY;
                    this.ow = this.cgObj.style.width;

                },
 
                // 移动
                move: function(event) {
                    event.preventDefault();                      // 阻止触摸事件的默认行为，即阻止滚屏
                    var m = event.targetTouches[0].pageY;
                    var n = event.targetTouches[1].pageY;
                    
                    if(m > this.aVal && this.aVal>this.cVal ){
                            document.getElementById("tee").innerHTML =this.oh;
                        this.cgObj.style.height = (m-this.aVal)+this.oh+"px";
                    }else if(n > this.cVal && this.cVal>this.aVal){
                        this.cgObj.style.height = (n-this.cVal)+this.oh+"px";
                    }else{}
                    //document.getElementById("clip").innerHTML = this.aVal + "===" + this.cVal;
        // document.getElementById("tee").innerHTML=event.touches[0].pageY +"=="+event.touches[1].pageY;
                    
                },
 
                // 滑动释放
                end: function(event) {
                    // 解绑事件
                    this.imgScale.removeEventListener('touchmove', this, false);
                    this.imgScale.removeEventListener('touchend', this, false);
                }
            },
 
            // 初始化
            init: function() {
                // this指slider对象
                var self = this;

                // addEventListener第二个参数可以传一个对象，会调用该对象的handleEvent属性
                if(!!self.touch) self.imgScale.addEventListener('touchstart', self.events, false);
            }
        };
 
        //imgScale.init();
</script>
</html>
